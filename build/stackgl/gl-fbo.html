<h1 id="gl-fbo">gl-fbo</h1>
<p>WebGL framebuffer object wrapper</p>
<iframe scrolling="no" seamless="seamless" src="http://stack.gl/gl-fbo/"></iframe><h2 id="example">Example</h2>
<p><a href="http://stackgl.github.io/gl-fbo/">Try this in your browser if you have WebGL</a></p>
<pre><code class="lang-javascript"><span class="kd">var</span> <span class="nx">shell</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;gl-now&quot;</span><span class="p">)()</span>
<span class="kd">var</span> <span class="nx">createFBO</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;gl-fbo&quot;</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">glslify</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;glslify&quot;</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">ndarray</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;ndarray&quot;</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">fill</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;ndarray-fill&quot;</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">fillScreen</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;a-big-triangle&quot;</span><span class="p">)</span>

<span class="kd">var</span> <span class="nx">createUpdateShader</span> <span class="o">=</span> <span class="nx">glslify</span><span class="p">({</span>
  <span class="nx">vertex</span><span class="o">:</span> <span class="s2">&quot;\</span>
<span class="s2">    attribute vec2 position;\</span>
<span class="s2">    varying vec2 uv;\</span>
<span class="s2">    void main() {\</span>
<span class="s2">      gl_Position = vec4(position,0.0,1.0);\</span>
<span class="s2">      uv = 0.5 * (position+1.0);\</span>
<span class="s2">    }&quot;</span><span class="p">,</span>
  <span class="nx">fragment</span><span class="o">:</span> <span class="s2">&quot;\</span>
<span class="s2">    precision mediump float;\</span>
<span class="s2">    uniform sampler2D buffer;\</span>
<span class="s2">    uniform vec2 dims;\</span>
<span class="s2">    varying vec2 uv;\</span>
<span class="s2">    void main() {\</span>
<span class="s2">      float n = 0.0;\</span>
<span class="s2">      for(int dx=-1; dx&lt;=1; ++dx)\</span>
<span class="s2">      for(int dy=-1; dy&lt;=1; ++dy) {\</span>
<span class="s2">        n += texture2D(buffer, uv+vec2(dx,dy)/dims).r;\</span>
<span class="s2">      }\</span>
<span class="s2">      float s = texture2D(buffer, uv).r;\</span>
<span class="s2">      if(n &gt; 3.0+s || n &lt; 3.0) {\</span>
<span class="s2">        gl_FragColor = vec4(0,0,0,1);\</span>
<span class="s2">      } else {\</span>
<span class="s2">        gl_FragColor = vec4(1,1,1,1);\</span>
<span class="s2">      }\</span>
<span class="s2">    }&quot;</span><span class="p">,</span>
  <span class="nx">inline</span><span class="o">:</span> <span class="kc">true</span>
<span class="p">})</span>

<span class="kd">var</span> <span class="nx">createDrawShader</span> <span class="o">=</span> <span class="nx">glslify</span><span class="p">({</span>
  <span class="nx">vertex</span><span class="o">:</span> <span class="s2">&quot;\</span>
<span class="s2">    attribute vec2 position;\</span>
<span class="s2">    varying vec2 uv;\</span>
<span class="s2">    void main() {\</span>
<span class="s2">      gl_Position = vec4(position,0.0,1.0);\</span>
<span class="s2">      uv = 0.5 * (position+1.0);\</span>
<span class="s2">    }&quot;</span><span class="p">,</span>
  <span class="nx">fragment</span><span class="o">:</span> <span class="s2">&quot;\</span>
<span class="s2">    precision mediump float;\</span>
<span class="s2">    uniform sampler2D buffer;\</span>
<span class="s2">    varying vec2 uv;\</span>
<span class="s2">    void main() {\</span>
<span class="s2">      gl_FragColor = texture2D(buffer, uv);\</span>
<span class="s2">    }&quot;</span><span class="p">,</span>
  <span class="nx">inline</span><span class="o">:</span> <span class="kc">true</span>
<span class="p">})</span>

<span class="kd">var</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">updateShader</span><span class="p">,</span> <span class="nx">drawShader</span><span class="p">,</span> <span class="nx">current</span> <span class="o">=</span> <span class="mi">0</span>

<span class="nx">shell</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;gl-init&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">gl</span> <span class="o">=</span> <span class="nx">shell</span><span class="p">.</span><span class="nx">gl</span>

  <span class="c1">//Turn off depth test</span>
  <span class="nx">gl</span><span class="p">.</span><span class="nx">disable</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">DEPTH_TEST</span><span class="p">)</span>

  <span class="c1">//Initialize shaders</span>
  <span class="nx">updateShader</span> <span class="o">=</span> <span class="nx">createUpdateShader</span><span class="p">(</span><span class="nx">gl</span><span class="p">)</span>
  <span class="nx">drawShader</span> <span class="o">=</span> <span class="nx">createDrawShader</span><span class="p">(</span><span class="nx">gl</span><span class="p">)</span>

  <span class="c1">//Allocate buffers</span>
  <span class="nx">state</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">createFBO</span><span class="p">(</span><span class="nx">gl</span><span class="p">,</span> <span class="p">[</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">]),</span> <span class="nx">createFBO</span><span class="p">(</span><span class="nx">gl</span><span class="p">,</span> <span class="p">[</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">])</span> <span class="p">]</span>

  <span class="c1">//Initialize state buffer</span>
  <span class="kd">var</span> <span class="nx">initial_conditions</span> <span class="o">=</span> <span class="nx">ndarray</span><span class="p">(</span><span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="mi">512</span><span class="o">*</span><span class="mi">512</span><span class="o">*</span><span class="mi">4</span><span class="p">),</span> <span class="p">[</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
  <span class="nx">fill</span><span class="p">(</span><span class="nx">initial_conditions</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="nx">y</span><span class="p">,</span><span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">c</span> <span class="o">===</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="mi">255</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.9</span> <span class="o">?</span> <span class="mi">255</span> <span class="o">:</span> <span class="mi">0</span>
  <span class="p">})</span>
  <span class="nx">state</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">color</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">setPixels</span><span class="p">(</span><span class="nx">initial_conditions</span><span class="p">)</span>

  <span class="c1">//Set up vertex pointers</span>
  <span class="nx">drawShader</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="nx">updateShader</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">})</span>

<span class="nx">shell</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;tick&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">gl</span> <span class="o">=</span> <span class="nx">shell</span><span class="p">.</span><span class="nx">gl</span>
  <span class="kd">var</span> <span class="nx">prevState</span> <span class="o">=</span> <span class="nx">state</span><span class="p">[</span><span class="nx">current</span><span class="p">]</span>
  <span class="kd">var</span> <span class="nx">curState</span> <span class="o">=</span> <span class="nx">state</span><span class="p">[</span><span class="nx">current</span> <span class="o">^=</span> <span class="mi">1</span><span class="p">]</span>

  <span class="c1">//Switch to state fbo</span>
  <span class="nx">curState</span><span class="p">.</span><span class="nx">bind</span><span class="p">()</span>

  <span class="c1">//Run update shader</span>
  <span class="nx">updateShader</span><span class="p">.</span><span class="nx">bind</span><span class="p">()</span>
  <span class="nx">updateShader</span><span class="p">.</span><span class="nx">uniforms</span><span class="p">.</span><span class="nx">buffer</span> <span class="o">=</span> <span class="nx">prevState</span><span class="p">.</span><span class="nx">color</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">bind</span><span class="p">()</span>
  <span class="nx">updateShader</span><span class="p">.</span><span class="nx">uniforms</span><span class="p">.</span><span class="nx">dims</span> <span class="o">=</span> <span class="nx">prevState</span><span class="p">.</span><span class="nx">shape</span>
  <span class="nx">fillScreen</span><span class="p">(</span><span class="nx">gl</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">shell</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;gl-render&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">gl</span> <span class="o">=</span> <span class="nx">shell</span><span class="p">.</span><span class="nx">gl</span>

  <span class="c1">//Render contents of buffer to screen</span>
  <span class="nx">drawShader</span><span class="p">.</span><span class="nx">bind</span><span class="p">()</span>
  <span class="nx">drawShader</span><span class="p">.</span><span class="nx">uniforms</span><span class="p">.</span><span class="nx">buffer</span> <span class="o">=</span> <span class="nx">state</span><span class="p">[</span><span class="nx">current</span><span class="p">].</span><span class="nx">color</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">bind</span><span class="p">()</span>
  <span class="nx">fillScreen</span><span class="p">(</span><span class="nx">gl</span><span class="p">)</span>
<span class="p">})</span>
</code></pre>
<p>Result:</p>
<p><img src="https://raw.github.com/stackgl/gl-fbo/master/screenshot.png"></p>
<h2 id="install">Install</h2>
<p>Install using npm:</p>
<pre><code>npm install gl-fbo
</code></pre><h1 id="api">API</h1>
<h3 id="-var-createfbo-require-gl-fbo-"><code>var createFBO = require(&quot;gl-fbo&quot;)</code></h3>
<h2 id="constructor">Constructor</h2>
<p>There is currently only one default way to create a Framebuffer object.  You can construct a framebuffer using the following syntax:</p>
<h3 id="-var-fbo-createfbo-gl-shape-options-"><code>var fbo = createFBO(gl, shape[, options])</code></h3>
<p>Creates a wrapped framebuffer object</p>
<ul>
<li><code>gl</code> is a handle to a WebGL context</li>
<li><code>shape</code> is a length 2 array encoding the <code>[width, height]</code> of the frame buffer</li>
<li><p><code>options</code> is an object containing the following optional properties:</p>
<ul>
<li><code>options.preferFloat</code> Upgrade to floating point if available, otherwise fallback to 8bit. (default <code>false</code>)</li>
<li><code>options.float</code> Use floating point textures (default <code>false</code>)</li>
<li><code>options.color</code>  The number of color buffers to create (default <code>1</code>)</li>
<li><code>options.depth</code> If fbo has a depth buffer (default: <code>true</code>)</li>
<li><code>options.stencil</code> If fbo has a stencil buffer (default: <code>false</code>)</li>
</ul>
</li>
</ul>
<h2 id="methods">Methods</h2>
<h3 id="-fbo-bind-"><code>fbo.bind()</code></h3>
<p>Binds the framebuffer object to the display.  To rebind the original drawing buffer, you can just call WebGL directly:</p>
<pre><code class="lang-javascript"><span class="c1">//Bind the drawing buffer</span>
<span class="nx">gl</span><span class="p">.</span><span class="nx">bindFramebuffer</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">FRAMEBUFFER</span><span class="p">,</span> <span class="kc">null</span><span class="p">)</span>
</code></pre>
<h3 id="-fbo-dispose-"><code>fbo.dispose()</code></h3>
<p>Destroys the framebuffer object and releases all associated resources</p>
<h2 id="properties">Properties</h2>
<h3 id="-fbo-shape-"><code>fbo.shape</code></h3>
<p>Returns the shape of the frame buffer object.  Writing to this property resizes the framebuffer.  For example,</p>
<pre><code class="lang-javascript"><span class="nx">fbo</span><span class="p">.</span><span class="nx">shape</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">newWidth</span><span class="p">,</span> <span class="nx">newHeight</span> <span class="p">]</span>
</code></pre>
<h3 id="-fbo-gl-"><code>fbo.gl</code></h3>
<p>A reference to the WebGL context</p>
<h3 id="-fbo-handle-"><code>fbo.handle</code></h3>
<p>A handle to the underlying Framebuffer object.</p>
<h3 id="-fbo-color-"><code>fbo.color</code></h3>
<p>An array containing <a href="https://github.com/stackgl/gl-texture2d"><code>gl-texture2d</code></a> objects representing the buffers.  </p>
<h3 id="-fbo-depth-"><code>fbo.depth</code></h3>
<p>The depth/stencil component of the FBO.  Stored as a <a href="https://github.com/stackgl/gl-texture2d"><code>gl-texture2d</code></a>.  If not present, is <code>null</code>.</p>
<h1 id="credits">Credits</h1>
<p>(c) 2013-2014 Mikola Lysenko. MIT License</p>
