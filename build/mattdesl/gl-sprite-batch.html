<h1 id="gl-sprite-batch"><a target="_blank" href="http://github.com/mattdesl/gl-sprite-batch">gl-sprite-batch</a></h1>
<p><a href="http://github.com/badges/stability-badges"></a></p>
<p>This is a high level 2D sprite (i.e. textured quad) batcher, ideal for optimized rendering of text glyphs, particles, sprites, rectangles/lines, icons, etc. It tries to push as many sprites into the same draw call as possible, until the capacity is reached or the texture changes. This allows it to take advantage of texture atlases for minimal draw calls.</p>
<p>Each sprite is an indexed quad with its own set of attributes:</p>
<ul>
<li><code>color</code> (vec4) - the RGBA color for a sprite</li>
<li><code>position</code> (vec2) - the x, y position</li>
<li><code>texcoord</code> (vec2) the UV texcoords for this sprite</li>
<li><code>shape</code> (vec2) - the width and height of the sprite&apos;s quad</li>
<li><code>texture</code> (gl-texture2d) - a texture or sprite sheet</li>
</ul>
<p>Note that <code>shape</code> and <code>texture</code> are not actual <em>vertex</em> attributes, although they may affect each sprite.</p>
<p>Typical Example:</p>
<pre><code class="lang-js"><span class="c1">//during your render loop...</span>
<span class="nx">batch</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">shader</span><span class="p">)</span>

<span class="c1">//clear the batch to zero sprites</span>
<span class="nx">batch</span><span class="p">.</span><span class="nx">clear</span><span class="p">()</span>

<span class="c1">//add your &quot;sprites&quot;</span>
<span class="nx">batch</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
    <span class="nx">position</span><span class="o">:</span> <span class="p">[</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">],</span>           <span class="c1">//defaults to [0, 0]</span>
    <span class="nx">shape</span><span class="o">:</span> <span class="p">[</span><span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">],</span>     <span class="c1">//defaults to [0, 0]</span>
    <span class="nx">color</span><span class="o">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>        <span class="c1">//defaults to [1, 1, 1, 1]</span>
    <span class="nx">texcoord</span><span class="o">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="c1">//defaults to [0, 0, 1, 1]</span>
    <span class="nx">texture</span><span class="o">:</span> <span class="nx">myTex</span>              <span class="c1">//defaults to 2x2 opaque white tex</span>
<span class="p">})</span>

<span class="c1">//flush any remaining sprites</span>
<span class="nx">batch</span><span class="p">.</span><span class="nx">draw</span><span class="p">()</span>

<span class="c1">//unbind it</span>
<span class="nx">batch</span><span class="p">.</span><span class="nx">unbind</span><span class="p">()</span>
</code></pre>
<h2 id="memory-efficiency">memory efficiency</h2>
<p>Object and array literals may be convenient for simple demos, but for larger applications this may lead to GC thrashing. For this you can use the bare <code>push()</code> method without any arguments, which will use whatever previous attributes have been set.</p>
<pre><code class="lang-js"><span class="c1">//pushes two sprites with some shared attributes</span>
<span class="nx">batch</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="nx">red</span>
<span class="nx">batch</span><span class="p">.</span><span class="nx">shape</span> <span class="o">=</span> <span class="p">[</span><span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">]</span>
<span class="nx">batch</span><span class="p">.</span><span class="nx">texture</span> <span class="o">=</span> <span class="nx">tex</span>
<span class="nx">batch</span><span class="p">.</span><span class="nx">texcoord</span> <span class="o">=</span> <span class="p">[</span><span class="nx">u</span><span class="p">,</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">u2</span><span class="p">,</span> <span class="nx">v2</span><span class="p">]</span>

<span class="nx">batch</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="nx">posA</span>
<span class="nx">batch</span><span class="p">.</span><span class="nx">push</span><span class="p">()</span>

<span class="nx">batch</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="nx">posB</span>
<span class="nx">batch</span><span class="p">.</span><span class="nx">push</span><span class="p">()</span>
</code></pre>
<h2 id="default-texture">default texture</h2>
<p>If you set the texture to <code>null</code> or <code>undefined</code>, it will use a <a href="https://www.npmjs.org/package/gl-white-texture">2x2 white texture</a> while drawing. This is useful for drawing filled primitives like rectangles and lines.</p>
<h2 id="transform">transform</h2>
<p>Often games and UIs will need per-sprite transformations, like rotation, scaling and positioning. Instead of changing uniform values for each sprite, this is often better to do on the CPU. The batch exposes a <code>transform</code> field, which can be a 4x4 matrix in the form of an array. You can modify this before calling <code>push()</code> to perform vertex transformations on the CPU. By default it is <code>null</code>, and transformations are ignored. </p>
<h1 id="rendering-modes">Rendering Modes</h1>
<p>The batch can be used for <a href="#dynamic">dynamic</a> or <a href="#static">static</a> quads. </p>
<h2 id="dynamic">dynamic</h2>
<p>Dynamic rendering is the easiest and most convenient, and is ideal for particle systems and sprite-based games. In this case, the sprites are pushed after calling <code>batch.bind(shader)</code>. This means that it can flush to the GPU when it reaches the max capacity, or when a new texture is being drawn.</p>
<p>To minimize flushes, you should always aim to use texture atlases. You can also provide a <code>dynamic</code> hint to the constructor, which allows the WebGL buffers to be optimized for dynamic updates. </p>
<p>The default batch capacity is 100, which you may want to alter for your needs.</p>
<pre><code class="lang-js"><span class="kd">var</span> <span class="nx">Batch</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&apos;gl-sprite-batch&apos;</span><span class="p">)</span>

<span class="c1">//hint that we&apos;re using dynamic buffers</span>
<span class="kd">var</span> <span class="nx">batch</span> <span class="o">=</span> <span class="nx">Batch</span><span class="p">({</span> <span class="nx">dynamic</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span>

<span class="kd">function</span> <span class="nx">render</span><span class="p">(</span><span class="nx">shader</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//bind the batch with your desired shader</span>
    <span class="nx">batch</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">shader</span><span class="p">)</span>

    <span class="c1">//clear the batch to zero sprites</span>
    <span class="nx">batch</span><span class="p">.</span><span class="nx">clear</span><span class="p">()</span>

    <span class="c1">//draw a variety of sprites/textures...</span>
    <span class="nx">batch</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
        <span class="nx">texture</span><span class="o">:</span> <span class="nx">myTex</span><span class="p">,</span>
        <span class="nx">position</span><span class="o">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="nx">shape</span><span class="o">:</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">]</span>
    <span class="p">})</span>
    <span class="nx">batch</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
        <span class="nx">texture</span><span class="o">:</span> <span class="nx">otherTex</span><span class="p">,</span>
        <span class="nx">position</span><span class="o">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="nx">shape</span><span class="o">:</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">]</span>
    <span class="p">})</span>

    <span class="c1">//now flush any remaining sprites and unbind the VAO</span>
    <span class="nx">batch</span><span class="p">.</span><span class="nx">draw</span><span class="p">()</span>
    <span class="nx">batch</span><span class="p">.</span><span class="nx">unbind</span><span class="p">()</span>
<span class="p">}</span>
</code></pre>
<h2 id="static">static</h2>
<p>A static batch is only suitable for a single texture (or sprite sheet) and a fixed capacity of sprites. This allows you to push a lot of sprites in a single draw call (like text glyphs) and leave them in a static buffer on the GPU.</p>
<p>For static usage, the sprites should be pushed before calling <code>bind()</code>. If you reach the max capacity, it will stop pushing new sprites to the batch. The batch will draw with whatever texture was last set (which means you can swap textures without updating any buffers). </p>
<p>Usually this is only needed if you find that dynamic batching is leading to bottlenecks. </p>
<pre><code class="lang-js"><span class="kd">var</span> <span class="nx">Batch</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&apos;gl-sprite-batch&apos;</span><span class="p">)</span>

<span class="c1">//draws max 100 sprites</span>
<span class="kd">var</span> <span class="nx">batch</span> <span class="o">=</span> <span class="nx">Batch</span><span class="p">({</span> <span class="nx">capacity</span><span class="o">:</span> <span class="mi">100</span> <span class="p">})</span>

<span class="c1">//push all our sprites</span>
<span class="nx">sprites</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">batch</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
<span class="p">})</span>

<span class="c1">//draw the static batch</span>
<span class="kd">function</span> <span class="nx">render</span><span class="p">(</span><span class="nx">shader</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">batch</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">shader</span><span class="p">)</span>
    <span class="nx">batch</span><span class="p">.</span><span class="nx">draw</span><span class="p">()</span>
    <span class="nx">batch</span><span class="p">.</span><span class="nx">unbind</span><span class="p">()</span>
<span class="p">}</span>
</code></pre>
<h2 id="usage">Usage</h2>
<p><a href="https://nodei.co/npm/gl-sprite-batch/"></a></p>
<h4 id="-batch-spritebatch-opts-"><code>batch = SpriteBatch([opts])</code></h4>
<p>Creates a new sprite batch with the given options.</p>
<ul>
<li><code>capacity</code> the max # of sprites that will be issued in a single draw call, default 100</li>
<li><code>dynamic</code> a hint for buffer usage; default false</li>
<li><code>mode</code> the mode used during rendering, default <code>gl.TRIANGLES</code></li>
<li><code>premultiplied</code> whether to premultiply RGB colors by their alpha component before pushing them to buffers, default false</li>
</ul>
<h4 id="-batch-create-opt-"><code>batch.create([opt])</code></h4>
<p>Disposes of the current buffers and re-builds them with the specified options:</p>
<ul>
<li><code>capacity</code> the max # of sprites that will be issued in a single draw call, default 100</li>
<li><code>dynamic</code> a hint for buffer usage; default false</li>
</ul>
<h4 id="-batch-bind-shader-"><code>batch.bind(shader)</code></h4>
<p>Binds the vertex array and specified shader. If sprites are pushed after this, they may be flushed to the GPU (i.e. if the texture changes or the capacity is reached). </p>
<h4 id="-batch-draw-"><code>batch.draw()</code></h4>
<p>Draws any remaining sprites to the screen. </p>
<h4 id="-batch-unbind-"><code>batch.unbind()</code></h4>
<p>Unbinds the vertex array.</p>
<h4 id="-batch-defaults-"><code>batch.defaults()</code></h4>
<p>Resets the vertex attributes to their default states:</p>
<pre><code class="lang-js"><span class="nx">batch</span><span class="p">.</span><span class="nx">texcoord</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="nx">batch</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="nx">batch</span><span class="p">.</span><span class="nx">shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="nx">batch</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</code></pre>
<h4 id="-batch-clear-"><code>batch.clear()</code></h4>
<p>Sets the buffer index to zero, essentially &quot;clearing&quot; the batch. Any subsequent sprites will be added to the start of the buffer.</p>
<h4 id="-batch-push-sprite-"><code>batch.push([sprite])</code></h4>
<p>Pushes the current vertex attributes onto the stack for rendering. If <code>sprite</code> is specified, it will try using those fields, or their respective defaults if they are falsey in the <code>sprite</code> object (see <a href="#shorthand">shorthand</a>). </p>
<h4 id="-batch-flush-"><code>batch.flush()</code></h4>
<p>Submits the current batch contents to the GPU, then calls <code>clear()</code>. This is needed during dynamic rendering, i.e. if we&apos;ve reached the batch capacity, or if we&apos;re switching textures. This is also necessary before updating shader uniforms or changing GL state.</p>
<h4 id="-batch-dispose-"><code>batch.dispose()</code></h4>
<p>Disposes the batch and its buffers/VAO.</p>
<h4 id="-batch-premultiplied-"><code>batch.premultiplied</code></h4>
<p>A boolean, default <code>false</code>, that described whether to alpha premultiply the current color while pushing it onto the vertex attribute stack.</p>
<h4 id="-batch-capacity-"><code>batch.capacity</code></h4>
<p>A read-only number representing the maximum number of sprites this batch can draw at once. </p>
<h4 id="-batch-texture-"><code>batch.texture</code></h4>
<p>A getter/setter for the batch&apos;s texture. If set to <code>null</code>, it will default to a <a href="https://www.npmjs.org/package/gl-white-texture">white 2x2 texture</a>.</p>
<h4 id="-batch-texcoord-"><code>batch.texcoord</code></h4>
<h4 id="-batch-color-"><code>batch.color</code></h4>
<h4 id="-batch-shape-"><code>batch.shape</code></h4>
<h4 id="-batch-position-"><code>batch.position</code></h4>
<p>Arrays for the current vertex attributes. These will not change unless a call to <code>push()</code> includes a <code>sprite</code> parameter.</p>
<h4 id="-batch-transform-"><code>batch.transform</code></h4>
<p>A 4x4 matrix array to transform each 2D point by. Default null (i.e. no transformation).</p>
<h4 id="-batch-mode-"><code>batch.mode</code></h4>
<p>The primitive drawing mode set during initialization; default <code>gl.TRIANGLES</code>.</p>
<h2 id="license">License</h2>
<p>MIT, see <a href="http://github.com/mattdesl/gl-sprite-batch/blob/master/LICENSE.md">LICENSE.md</a> for details.</p>
